name: Boom SLA (API, REST)

on:
  schedule:
    - cron: "*/5 * * * *"     # every 5 minutes
  workflow_dispatch:
    inputs:
      conversation:
        description: "Conversation (UI URL / API URL / UUID). Optional if DEFAULT_CONVERSATION_ID is set."
        required: false
  repository_dispatch:

jobs:
  run:
    runs-on: ubuntu-latest
    env:
      # Secrets for Boom login and SMTP
      BOOM_USER: ${{ secrets.BOOM_USER }}
      BOOM_PASS: ${{ secrets.BOOM_PASS }}
      SMTP_HOST: ${{ secrets.SMTP_HOST }}
      SMTP_PORT: ${{ secrets.SMTP_PORT }}
      SMTP_USER: ${{ secrets.SMTP_USER }}
      SMTP_PASS: ${{ secrets.SMTP_PASS }}
      ALERT_TO:  ${{ secrets.ALERT_TO }}
      ALERT_FROM_NAME: ${{ secrets.ALERT_FROM_NAME }}

      # Boom auth & API
      LOGIN_URL: "https://app.boomnow.com/api/login"
      LOGIN_METHOD: "POST"
      LOGIN_CT: "application/json"
      LOGIN_EMAIL_FIELD: "email"
      LOGIN_PASSWORD_FIELD: "password"
      LOGIN_TENANT_FIELD: ""      # set if your tenant login requires it
      CSRF_HEADER_NAME: ""
      CSRF_COOKIE_NAME: ""

      API_KIND: "rest"
      MESSAGES_URL: "https://app.boomnow.com/api/conversations/{{conversationId}}"
      MESSAGES_METHOD: "GET"

      # SLA configuration
      SLA_MINUTES: "5"
      SLA_GRACE_SECONDS: "90"           # <-- new: buffer to avoid jitter false alerts
      COUNT_AI_SUGGESTION_AS_AGENT: "false"

      # Input from dispatch/manual
      CONVERSATION_INPUT: ${{ github.event.inputs.conversation || github.event.client_payload.conversation || github.event.client_payload.conversationUrl || github.event.client_payload.conversation_url || github.event.client_payload.url || github.event.client_payload.text || github.event.client_payload.body }}
      DEFAULT_CONVERSATION_ID: ${{ vars.DEFAULT_CONVERSATION_ID }}

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
      - name: Install deps
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm i
          fi
      - name: Run SLA checker
        run: node check.mjs
