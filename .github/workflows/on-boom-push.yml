name: Wire GitHub Actions to call Azure Function

on:
  repository_dispatch:
    types: [boom_message]

jobs:
  forward-to-azure-fn:
    runs-on: ubuntu-latest
    steps:
      - name: Prepare payload
        run: |
          echo '${{ toJson(github.event.client_payload) }}' > payload.json
          ls -lh payload.json && head -c 200 payload.json || true

      - name: Call Azure Function
        env:
          FN_BASE: ${{ secrets.AZURE_FN_BASE }}
          FN_CODE: ${{ secrets.AZURE_FN_CODE }}
          SHARED_SECRET: ${{ secrets.SHARED_SECRET }}
        run: |
          set -euo pipefail
          FN_URL="${FN_BASE%/}/api/boom-notify?code=${FN_CODE}"
          echo "POST -> ${FN_URL//*code=/}***"
          curl -sS -X POST "$FN_URL" \
            -H "Content-Type: application/json" \
            -H "X-Shared-Secret: ${SHARED_SECRET}" \
            --data-binary @payload.json \
            -o /tmp/resp.json -w "\nHTTP %{http_code}\n"
          echo "Response:" && cat /tmp/resp.json || true
